<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextBizness - Business from Zero to Hero</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš€</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .view { display: none; }
        .active-view { display: block; }
        .certificate {
            border: 12px solid #a16207;
            padding: 2.5rem;
            background-color: #fffbeb;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ca8a04' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .admin-nav button.active {
            background-color: #1d4ed8;
            color: white;
        }
        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-pending { background-color: #f59e0b; }
        .status-success { background-color: #22c55e; }
        .status-error { background-color: #ef4444; }
    </style>
</head>
<body class="text-gray-800">

    <!-- =========== VIEWS CONTAINER =========== -->

    <!-- 1. AUTHENTICATION VIEW -->
    <div id="auth-view" class="view min-h-screen flex items-center justify-center bg-gray-100">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <!-- Login Form -->
            <div id="login-form">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Welcome Back!</h2>
                <p class="text-center text-gray-500 mb-6">Sign in to continue your journey.</p>
                <div id="login-error" class="text-red-500 text-sm mb-4 text-center p-2 bg-red-50 rounded-md border border-red-200 hidden"></div>
                <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="loginUser()" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition font-semibold">Login</button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Don't have an account? <a href="#" onclick="toggleAuthForms()" class="text-blue-600 hover:underline">Sign Up</a>
                </p>
            </div>
            <!-- Signup Form -->
            <div id="signup-form" class="hidden">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Create Account</h2>
                <p class="text-center text-gray-500 mb-6">Start your business education today.</p>
                <div id="signup-error" class="text-red-500 text-sm mb-4 text-center p-2 bg-red-50 rounded-md border border-red-200 hidden"></div>
                <input type="text" id="signup-name" placeholder="Full Name" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="email" id="signup-email" placeholder="Email" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="signup-password" placeholder="Password" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="signupUser()" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition font-semibold">Sign Up</button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Already have an account? <a href="#" onclick="toggleAuthForms()" class="text-blue-600 hover:underline">Login</a>
                </p>
            </div>
            <!-- NEW: Diagnostics Button -->
            <div class="text-center mt-6">
                <button onclick="showView('diagnostics-view')" class="text-xs text-gray-400 hover:text-gray-600">Connection Issues?</button>
            </div>
        </div>
    </div>

    <!-- 2. STUDENT APP VIEW -->
    <div id="app-view" class="view">
        <!-- ... (same as before) ... -->
    </div>

    <!-- 3. ADMIN PANEL VIEW -->
    <div id="admin-view" class="view">
        <!-- ... (same as before) ... -->
    </div>

    <!-- 4. LOADING VIEW -->
    <div id="loading-view" class="view active-view min-h-screen flex items-center justify-center">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-blue-600 text-5xl"></i>
            <p class="mt-4 text-lg text-gray-600">Loading NextBizness...</p>
        </div>
    </div>
    
    <!-- 5. NEW: DIAGNOSTICS VIEW -->
    <div id="diagnostics-view" class="view min-h-screen flex items-center justify-center bg-gray-100">
        <div class="max-w-2xl w-full bg-white p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-center mb-4">Firebase Connection Diagnostics</h2>
            <p class="text-center text-gray-600 mb-6">This tool checks if the website can connect to the Firebase services required for it to work.</p>
            <div class="text-center mb-6">
                <button onclick="runDiagnostics()" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700">Run Diagnostics</button>
            </div>
            <div class="space-y-4">
                <div class="p-4 bg-gray-50 rounded-md">
                    <h3 class="font-semibold flex items-center"><span id="auth-status-dot" class="status-dot mr-2"></span>1. Authentication Service</h3>
                    <p id="auth-status-text" class="text-sm text-gray-500 mt-1 ml-5">Status: Pending</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-md">
                    <h3 class="font-semibold flex items-center"><span id="db-read-status-dot" class="status-dot mr-2"></span>2. Firestore Database (Read)</h3>
                    <p id="db-read-status-text" class="text-sm text-gray-500 mt-1 ml-5">Status: Pending</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-md">
                    <h3 class="font-semibold flex items-center"><span id="db-write-status-dot" class="status-dot mr-2"></span>3. Firestore Database (Write)</h3>
                    <p id="db-write-status-text" class="text-sm text-gray-500 mt-1 ml-5">Status: Pending</p>
                </div>
            </div>
            <div class="text-center mt-8">
                <button onclick="showView('auth-view')" class="text-sm text-gray-500 hover:text-gray-700">&larr; Back to Login</button>
            </div>
        </div>
    </div>


    <!-- MODALS (shared across views) -->
    <div id="certificate-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <!-- ... (same as before) ... -->
    </div>


    <!-- =========== FIREBASE & JAVASCRIPT =========== -->
    <script type="module">
        // --- FIREBASE SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            signInAnonymously // NEW: For diagnostics
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            getDocs,
            updateDoc,
            deleteDoc,
            query,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIG (as provided) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAdOpB618-pYq5iHJIErhFeaGUUlJ1KYew",
            authDomain: "nextbuzness.firebaseapp.com",
            projectId: "nextbuzness",
            storageBucket: "nextbuzness.appspot.com",
            messagingSenderId: "9188411983",
            appId: "1:9188411983:web:7e1d7dec6b62aa8965f83a",
            measurementId: "G-EMYW513V6H"
        };

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userData = null;
        const ADMIN_EMAILS = ['mostafa@example.com', 'osama@example.com'];

        // --- CORE APP LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (user && !user.isAnonymous) { // Ignore anonymous diagnostic user
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                
                if (userDocSnap.exists()) {
                    userData = userDocSnap.data();
                    if (ADMIN_EMAILS.includes(user.email)) {
                        showView('admin-view');
                    } else {
                        showView('app-view');
                    }
                } else {
                    console.warn("User document not found, attempting to create it now.");
                    try {
                        const name = user.displayName || "New User";
                        await setDoc(doc(db, "users", user.uid), { name, email: user.email, joined: new Date() });
                        window.location.reload();
                    } catch (e) {
                        console.error("Failed to create user document on fallback:", e);
                        showError('signup-error', `Account created, but could not save profile. Error: ${e.message}. Please check Firestore rules.`);
                        showView('auth-view');
                    }
                }
            } else if (!user) {
                currentUser = null;
                userData = null;
                showView('auth-view');
            }
        });

        // --- VIEW MANAGEMENT & ERROR DISPLAY ---
        window.showView = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            document.getElementById(viewId).classList.add('active-view');
        }
        
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        function clearErrors() {
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('signup-error').classList.add('hidden');
        }

        window.toggleAuthForms = () => {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('signup-form').classList.toggle('hidden');
            clearErrors();
        }

        // --- AUTHENTICATION FUNCTIONS ---
        window.loginUser = async () => {
            clearErrors();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) {
                showError('login-error', "Please fill all fields.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login Error:", error);
                showError('login-error', `Login Failed: ${error.message}. This is often caused by incorrect API key restrictions in your Google Cloud project.`);
            }
        };

        window.signupUser = async () => {
            clearErrors();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            if (!name || !email || !password) {
                showError('signup-error', "Please fill all fields.");
                return;
            }
            try {
                // We only create the auth user here. The onAuthStateChanged listener will handle creating the db record.
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Signup Error:", error);
                showError('signup-error', `Signup Failed: ${error.message}. This is often caused by incorrect API key restrictions in your Google Cloud project.`);
            }
        };

        window.logoutUser = async () => {
            await signOut(auth);
            window.location.reload();
        };
        
        // --- NEW: DIAGNOSTICS FUNCTIONS ---
        function setStatus(type, status, message) {
            const dot = document.getElementById(`${type}-status-dot`);
            const text = document.getElementById(`${type}-status-text`);
            dot.className = `status-dot mr-2 status-${status}`;
            text.innerHTML = `<strong>Status:</strong> ${message}`;
        }

        window.runDiagnostics = async () => {
            // 1. Test Auth
            setStatus('auth', 'pending', 'Connecting to Authentication Service...');
            try {
                const userCredential = await signInAnonymously(auth);
                setStatus('auth', 'success', 'Successfully connected to Authentication Service.');
                await signOut(auth); // Sign out the anonymous user
            } catch (error) {
                setStatus('auth', 'error', `Failed. Error: ${error.message}. <strong>Fix:</strong> Check your API Key restrictions in Google Cloud Console.`);
                setStatus('db-read', 'error', 'Skipped. Auth connection failed.');
                setStatus('db-write', 'error', 'Skipped. Auth connection failed.');
                return;
            }

            // 2. Test Firestore Read
            setStatus('db-read', 'pending', 'Attempting to read from database...');
            try {
                const docRef = doc(db, "debug", "testRead");
                await getDoc(docRef);
                setStatus('db-read', 'success', 'Successfully read from the database.');
            } catch (error) {
                setStatus('db-read', 'error', `Failed. Error: ${error.message}. <strong>Fix:</strong> Check your Firestore Security Rules to allow reads.`);
            }

            // 3. Test Firestore Write
            setStatus('db-write', 'pending', 'Attempting to write to database...');
            try {
                const docRef = doc(db, "debug", "testWrite");
                await setDoc(docRef, { timestamp: new Date() });
                setStatus('db-write', 'success', 'Successfully wrote to the database.');
            } catch (error) {
                setStatus('db-write', 'error', `Failed. Error: ${error.message}. <strong>Fix:</strong> Check your Firestore Security Rules to allow writes.`);
            }
        };
        
        // --- Other functions (Admin, Student, Certificate) would go here ---
        // For brevity, they are omitted but are the same as the previous version.

    </script>
</body>
</html>



