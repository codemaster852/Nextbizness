<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextBizness - Business from Zero to Hero</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš€</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .view { display: none; }
        .active-view { display: block; }
        .certificate {
            border: 12px solid #a16207;
            padding: 2.5rem;
            background-color: #fffbeb;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ca8a04' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .admin-nav button.active {
            background-color: #1d4ed8;
            color: white;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- =========== VIEWS CONTAINER =========== -->
    <!-- All major sections are "views" that are shown/hidden -->

    <!-- 1. AUTHENTICATION VIEW -->
    <div id="auth-view" class="view min-h-screen flex items-center justify-center bg-gray-100">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <!-- Login Form -->
            <div id="login-form">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Welcome Back!</h2>
                <p class="text-center text-gray-500 mb-6">Sign in to continue your journey.</p>
                <div id="login-error" class="text-red-500 text-sm mb-4 text-center p-2 bg-red-50 rounded-md border border-red-200 hidden"></div>
                <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="loginUser()" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition font-semibold">Login</button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Don't have an account? <a href="#" onclick="toggleAuthForms()" class="text-blue-600 hover:underline">Sign Up</a>
                </p>
            </div>
            <!-- Signup Form -->
            <div id="signup-form" class="hidden">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Create Account</h2>
                <p class="text-center text-gray-500 mb-6">Start your business education today.</p>
                <div id="signup-error" class="text-red-500 text-sm mb-4 text-center p-2 bg-red-50 rounded-md border border-red-200 hidden"></div>
                <input type="text" id="signup-name" placeholder="Full Name" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="email" id="signup-email" placeholder="Email" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="signup-password" placeholder="Password" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="signupUser()" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition font-semibold">Sign Up</button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Already have an account? <a href="#" onclick="toggleAuthForms()" class="text-blue-600 hover:underline">Login</a>
                </p>
            </div>
        </div>
    </div>

    <!-- 2. STUDENT APP VIEW -->
    <div id="app-view" class="view">
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-900">NextBizness</h1>
                <div>
                    <span id="user-greeting" class="text-gray-600 mr-4"></span>
                    <button onclick="logoutUser()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition text-sm">Logout</button>
                </div>
            </div>
        </header>
        <main id="student-main-content" class="container mx-auto p-6"></main>
    </div>

    <!-- 3. ADMIN PANEL VIEW -->
    <div id="admin-view" class="view">
        <header class="bg-gray-800 text-white shadow-lg">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-3xl font-bold">Admin Panel</h1>
                <div>
                    <span id="admin-greeting" class="mr-4"></span>
                    <button onclick="logoutUser()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition text-sm">Logout</button>
                </div>
            </div>
        </header>
        <main id="admin-main-content" class="flex-1 p-8 bg-gray-100"></main>
    </div>

    <!-- 4. LOADING VIEW -->
    <div id="loading-view" class="view active-view min-h-screen flex items-center justify-center">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-blue-600 text-5xl"></i>
            <p class="mt-4 text-lg text-gray-600">Loading NextBizness...</p>
        </div>
    </div>

    <!-- MODALS -->
    <div id="admin-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div id="admin-modal-content" class="modal-content bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full transform scale-95">
            <!-- Dynamic content will be injected here -->
        </div>
    </div>

    <div id="certificate-modal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full">
            <h2 class="text-2xl font-bold mb-4 text-center">Congratulations!</h2>
            <div id="certificate-display" class="mt-2">
                <div id="certificate-wrapper" class="certificate mx-auto max-w-3xl">
                    <div class="text-center">
                        <h1 class="text-5xl font-bold text-gray-800" style="font-family: 'Garamond', serif;">Certificate of Completion</h1>
                        <p class="text-lg mt-4">This certificate is proudly presented to</p>
                        <p id="certificate-name" class="text-4xl font-semibold text-yellow-700 my-8"></p>
                        <p class="text-lg">for successfully completing the</p>
                        <h2 id="certificate-title" class="text-3xl font-semibold text-gray-700 mt-2"></h2>
                        <div class="flex justify-around items-center mt-12 text-sm">
                            <div><p class="font-bold">MRC University</p><img src="https://googleusercontent.com/file_content/2" alt="MRC University Logo" class="mx-auto mt-2 h-16 object-contain"></div>
                            <div><p class="font-bold">NextBizness</p><img src="https://placehold.co/120x60/e2e8f0/4a5568?text=NextBizness" alt="NextBizness Logo" class="mx-auto mt-2"></div>
                            <div><p class="font-bold">MNC News</p><img src="https://googleusercontent.com/file_content/1" alt="MNC News Logo" class="mx-auto mt-2 h-16 object-contain"></div>
                        </div>
                        <p class="text-xs mt-8 text-gray-500">Issued on: <span id="certificate-date"></span></p>
                    </div>
                </div>
                 <div class="text-center mt-6 flex justify-center gap-4">
                    <button onclick="downloadCertificate()" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition"><i class="fas fa-download mr-2"></i>Download</button>
                    <button onclick="closeModal('certificate-modal')" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400 transition">Close</button>
                </div>
            </div>
        </div>
    </div>


    <!-- =========== FIREBASE & JAVASCRIPT =========== -->
    <script type="module">
        // --- FIREBASE SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, getDocs, updateDoc, deleteDoc, query, writeBatch, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAdOpB618-pYq5iHJIErhFeaGUUlJ1KYew",
            authDomain: "nextbuzness.firebaseapp.com",
            projectId: "nextbuzness",
            storageBucket: "nextbuzness.appspot.com",
            messagingSenderId: "9188411983",
            appId: "1:9188411983:web:7e1d7dec6b62aa8965f83a",
            measurementId: "G-EMYW513V6H"
        };

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userData = null;
        const ADMIN_EMAILS = ['mostafaalatawy3@gmail.com'];

        // --- CORE APP LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const isAdmin = ADMIN_EMAILS.includes(user.email);
                const userDocRef = doc(db, "users", user.uid);
                
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    
                    if (userDocSnap.exists()) {
                        userData = userDocSnap.data();
                        // Ensure isAdmin flag is correctly set for admins
                        if (isAdmin && !userData.isAdmin) {
                            await updateDoc(userDocRef, { isAdmin: true });
                            userData.isAdmin = true;
                        }
                    } else {
                        console.warn("User document not found, creating it now.");
                        const name = user.displayName || "New User";
                        userData = { name, email: user.email, joined: new Date(), completedUnits: [], completedPaths: [], isAdmin };
                        await setDoc(userDocRef, userData);
                    }

                    // Redirect based on admin status
                    if (userData.isAdmin) {
                        document.getElementById('admin-greeting').innerText = `Hello, ${userData.name}`;
                        showView('admin-view');
                        renderAdminPaths();
                    } else {
                        document.getElementById('user-greeting').innerText = `Hello, ${userData.name}`;
                        showView('app-view');
                        showStudentHomepage();
                    }

                } catch (error) {
                    console.error("Firestore Error after login:", error);
                    await signOut(auth);
                    showError('login-error', `Login succeeded, but could not read your profile. This is a Firestore Security Rules issue. Error: ${error.message}`);
                }
            } else {
                currentUser = null;
                userData = null;
                showView('auth-view');
            }
        });

        // --- VIEW & MODAL MANAGEMENT ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            if (viewId !== 'loading-view') {
                document.getElementById('loading-view').classList.remove('active-view');
            }
            document.getElementById(viewId).classList.add('active-view');
        }
        
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        function clearErrors() {
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('signup-error').classList.add('hidden');
        }

        window.toggleAuthForms = () => {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('signup-form').classList.toggle('hidden');
            clearErrors();
        }

        window.openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 250);
        }

        // --- AUTHENTICATION FUNCTIONS ---
        window.loginUser = async () => {
            clearErrors();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) { showError('login-error', "Please fill all fields."); return; }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login Error:", error);
                showError('login-error', `Login Failed: ${error.code}`);
            }
        };

        window.signupUser = async () => {
            clearErrors();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            if (!name || !email || !password) { showError('signup-error', "Please fill all fields."); return; }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Signup Error:", error);
                showError('signup-error', `Signup Failed: ${error.code}`);
            }
        };

        window.logoutUser = async () => {
            await signOut(auth);
            window.location.reload();
        };
        
        // --- STUDENT VIEW FUNCTIONS ---
        async function showStudentHomepage() {
            // ... (Implementation would go here)
        }

        // --- ADMIN PANEL ---
        const adminContent = document.getElementById('admin-main-content');

        async function renderAdminPaths() {
            adminContent.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-3xl"></i></div>`;
            const pathsSnapshot = await getDocs(collection(db, "paths"));
            let html = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Course Paths</h2>
                    <button onclick="showPathForm()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>Add New Path
                    </button>
                </div>
                <div class="space-y-4">
            `;
            for (const doc of pathsSnapshot.docs) {
                const path = { id: doc.id, ...doc.data() };
                const unitsSnapshot = await getDocs(collection(db, `paths/${path.id}/units`));
                html += `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold">${path.title}</h3>
                                <p class="text-gray-600">${path.description}</p>
                                <p class="text-sm text-gray-500 mt-1">Certificate Title: ${path.certificateTitle || 'Not set'}</p>
                            </div>
                            <div class="flex-shrink-0 ml-4">
                                <button onclick="showPathForm('${path.id}')" class="text-blue-500 hover:text-blue-700 mr-2"><i class="fas fa-edit"></i></button>
                                <button onclick="deletePath('${path.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="border-t mt-4 pt-4">
                            <div class="flex justify-between items-center">
                                <h4 class="font-semibold">Units (${unitsSnapshot.size})</h4>
                                <button onclick="showUnitForm('${path.id}')" class="bg-gray-200 text-sm px-3 py-1 rounded-md hover:bg-gray-300">Add Unit</button>
                            </div>
                            <div class="mt-2 space-y-2">
                                ${unitsSnapshot.docs.map(unitDoc => {
                                    const unit = {id: unitDoc.id, ...unitDoc.data()};
                                    return `<div class="p-2 bg-gray-50 rounded-md flex justify-between items-center">
                                        <span>${unit.title}</span>
                                        <div>
                                            <button onclick="showUnitForm('${path.id}', '${unit.id}')" class="text-blue-500 hover:text-blue-700 mr-2 text-sm"><i class="fas fa-edit"></i></button>
                                            <button onclick="deleteUnit('${path.id}', '${unit.id}')" class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            html += `</div>`;
            adminContent.innerHTML = html;
        }

        // FORM MODALS
        window.showPathForm = async (pathId = null) => {
            let path = {};
            if (pathId) {
                const docSnap = await getDoc(doc(db, "paths", pathId));
                path = docSnap.data();
            }
            const modalContent = document.getElementById('admin-modal-content');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">${pathId ? 'Edit' : 'Add'} Path</h2>
                <input id="path-title" class="w-full p-2 border rounded mb-2" placeholder="Path Title" value="${path.title || ''}">
                <textarea id="path-desc" class="w-full p-2 border rounded mb-2" placeholder="Path Description">${path.description || ''}</textarea>
                <input id="path-cert-title" class="w-full p-2 border rounded mb-4" placeholder="Certificate Title for this Path" value="${path.certificateTitle || ''}">
                <div class="flex justify-end gap-4">
                    <button onclick="closeModal('admin-modal')" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
                    <button onclick="savePath('${pathId || ''}')" class="bg-blue-600 text-white px-4 py-2 rounded">Save Path</button>
                </div>
            `;
            openModal('admin-modal');
        }

        window.showUnitForm = async (pathId, unitId = null) => {
            let unit = {};
            if (unitId) {
                const docSnap = await getDoc(doc(db, `paths/${pathId}/units`, unitId));
                unit = docSnap.data();
            }
            const modalContent = document.getElementById('admin-modal-content');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">${unitId ? 'Edit' : 'Add'} Unit</h2>
                <input id="unit-title" class="w-full p-2 border rounded mb-4" placeholder="Unit Title" value="${unit.title || ''}">
                <div class="flex justify-end gap-4">
                    <button onclick="closeModal('admin-modal')" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
                    <button onclick="saveUnit('${pathId}', '${unitId || ''}')" class="bg-blue-600 text-white px-4 py-2 rounded">Save Unit</button>
                </div>
            `;
            openModal('admin-modal');
        }

        // SAVE & DELETE LOGIC
        window.savePath = async (pathId) => {
            const data = {
                title: document.getElementById('path-title').value,
                description: document.getElementById('path-desc').value,
                certificateTitle: document.getElementById('path-cert-title').value
            };
            if (!data.title || !data.description || !data.certificateTitle) { alert('Please fill all fields.'); return; }
            
            if (pathId) {
                await updateDoc(doc(db, "paths", pathId), data);
            } else {
                await addDoc(collection(db, "paths"), data);
            }
            closeModal('admin-modal');
            renderAdminPaths();
        }

        window.deletePath = async (pathId) => {
            if (!confirm('Are you sure you want to delete this entire path and all its units?')) return;
            // Note: This does not delete subcollections. For a production app, a Cloud Function is needed for that.
            await deleteDoc(doc(db, "paths", pathId));
            renderAdminPaths();
        }

        window.saveUnit = async (pathId, unitId) => {
            const data = { title: document.getElementById('unit-title').value };
            if (!data.title) { alert('Please enter a title.'); return; }
            
            if (unitId) {
                await updateDoc(doc(db, `paths/${pathId}/units`, unitId), data);
            } else {
                await addDoc(collection(db, `paths/${pathId}/units`), data);
            }
            closeModal('admin-modal');
            renderAdminPaths();
        }

        window.deleteUnit = async (pathId, unitId) => {
            if (!confirm('Are you sure you want to delete this unit?')) return;
            await deleteDoc(doc(db, `paths/${pathId}/units`, unitId));
            renderAdminPaths();
        }

    </script>
</body>
</html>
