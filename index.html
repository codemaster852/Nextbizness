<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextBizness - Business from Zero to Hero</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš€</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .view { display: none; }
        .active-view { display: block; }
        .certificate {
            border: 12px solid #a16207;
            padding: 2.5rem;
            background-color: #fffbeb;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ca8a04' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .admin-nav button.active {
            background-color: #1d4ed8;
            color: white;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- =========== VIEWS CONTAINER =========== -->
    <!-- All major sections are "views" that are shown/hidden -->

    <!-- 1. AUTHENTICATION VIEW -->
    <div id="auth-view" class="view min-h-screen flex items-center justify-center bg-gray-100">
        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
            <!-- Login Form -->
            <div id="login-form">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Welcome Back!</h2>
                <p class="text-center text-gray-500 mb-6">Sign in to continue your journey.</p>
                <div id="login-error" class="text-red-500 text-sm mb-4 text-center p-2 bg-red-50 rounded-md border border-red-200 hidden"></div>
                <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="loginUser()" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition font-semibold">Login</button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Don't have an account? <a href="#" onclick="toggleAuthForms()" class="text-blue-600 hover:underline">Sign Up</a>
                </p>
            </div>
            <!-- Signup Form -->
            <div id="signup-form" class="hidden">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-2">Create Account</h2>
                <p class="text-center text-gray-500 mb-6">Start your business education today.</p>
                <div id="signup-error" class="text-red-500 text-sm mb-4 text-center p-2 bg-red-50 rounded-md border border-red-200 hidden"></div>
                <input type="text" id="signup-name" placeholder="Full Name" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="email" id="signup-email" placeholder="Email" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="signup-password" placeholder="Password" class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="signupUser()" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition font-semibold">Sign Up</button>
                <p class="text-center text-sm text-gray-600 mt-4">
                    Already have an account? <a href="#" onclick="toggleAuthForms()" class="text-blue-600 hover:underline">Login</a>
                </p>
            </div>
        </div>
    </div>

    <!-- 2. STUDENT APP VIEW -->
    <div id="app-view" class="view">
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-900">NextBizness</h1>
                <div>
                    <span id="user-greeting" class="text-gray-600 mr-4"></span>
                    <button onclick="logoutUser()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition text-sm">Logout</button>
                </div>
            </div>
        </header>
        <main id="student-main-content" class="container mx-auto p-6"></main>
    </div>

    <!-- 3. ADMIN PANEL VIEW -->
    <div id="admin-view" class="view">
        <header class="bg-gray-800 text-white shadow-lg">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-3xl font-bold">Admin Panel</h1>
                <div>
                    <span id="admin-greeting" class="mr-4"></span>
                    <button onclick="logoutUser()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition text-sm">Logout</button>
                </div>
            </div>
        </header>
        <div class="flex">
            <nav class="w-64 bg-gray-700 text-white min-h-screen p-4 admin-nav">
                <ul>
                    <li><button onclick="showAdminSection('admin-dashboard')" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-600 active"><i class="fas fa-tachometer-alt mr-2"></i>Dashboard</button></li>
                    <li><button onclick="showAdminSection('admin-paths')" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-600"><i class="fas fa-road mr-2"></i>Manage Paths</button></li>
                    <li><button onclick="showAdminSection('admin-users')" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-600"><i class="fas fa-users mr-2"></i>Manage Users</button></li>
                </ul>
            </nav>
            <main id="admin-main-content" class="flex-1 p-8 bg-gray-100">
                <!-- Admin content will be loaded here -->
            </main>
        </div>
    </div>

    <!-- 4. LOADING VIEW -->
    <div id="loading-view" class="view active-view min-h-screen flex items-center justify-center">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-blue-600 text-5xl"></i>
            <p class="mt-4 text-lg text-gray-600">Loading NextBizness...</p>
        </div>
    </div>

    <!-- MODALS (shared across views) -->
    <div id="certificate-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full">
            <h2 class="text-2xl font-bold mb-4 text-center">Congratulations!</h2>
            <p class="text-center mb-6">You've successfully completed the course. Your name is pre-filled below.</p>
            <div id="certificate-display" class="mt-2">
                <div id="certificate-wrapper" class="certificate mx-auto max-w-3xl">
                    <div class="text-center">
                        <h1 class="text-5xl font-bold text-gray-800" style="font-family: 'Garamond', serif;">Certificate of Completion</h1>
                        <p class="text-lg mt-4">This certificate is proudly presented to</p>
                        <p id="certificate-name" class="text-4xl font-semibold text-yellow-700 my-8"></p>
                        <p class="text-lg">for successfully completing the</p>
                        <h2 class="text-3xl font-semibold text-gray-700 mt-2">Business: From Zero to Hero</h2>
                        <p class="text-md mt-8">This course covers foundational and advanced topics in business, including financial skills, business fundamentals, marketing, and strategic growth.</p>
                        <div class="flex justify-around items-center mt-12 text-sm">
                            <div>
                                <p class="font-bold">MRC University</p>
                                <img src="https://googleusercontent.com/file_content/2" alt="MRC University Logo" class="mx-auto mt-2 h-16 object-contain">
                            </div>
                            <div>
                                <p class="font-bold">NextBizness</p>
                                <img src="https://placehold.co/120x60/e2e8f0/4a5568?text=NextBizness" alt="NextBizness Logo" class="mx-auto mt-2">
                            </div>
                             <div>
                                <p class="font-bold">MNC News</p>
                                <img src="https://googleusercontent.com/file_content/1" alt="MNC News Logo" class="mx-auto mt-2 h-16 object-contain">
                            </div>
                        </div>
                        <p class="text-xs mt-8 text-gray-500">Issued on: <span id="certificate-date"></span></p>
                    </div>
                </div>
                 <div class="text-center mt-6 flex justify-center gap-4">
                    <button onclick="downloadCertificate()" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition"><i class="fas fa-download mr-2"></i>Download</button>
                    <button onclick="closeCertificateModal()" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400 transition">Close</button>
                </div>
            </div>
        </div>
    </div>


    <!-- =========== FIREBASE & JAVASCRIPT =========== -->
    <script type="module">
        // --- FIREBASE SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            getDocs,
            updateDoc,
            deleteDoc,
            query,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIG (as provided) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAdOpB618-pYq5iHJIErhFeaGUUlJ1KYew",
            authDomain: "nextbuzness.firebaseapp.com",
            projectId: "nextbuzness",
            storageBucket: "nextbuzness.appspot.com",
            messagingSenderId: "9188411983",
            appId: "1:9188411983:web:7e1d7dec6b62aa8965f83a",
            measurementId: "G-EMYW513V6H"
        };

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userData = null;
        const ADMIN_EMAILS = ['mostafa@example.com', 'osama@example.com']; // IMPORTANT: Change to your actual admin emails

        // --- CORE APP LOGIC ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    
                    if (userDocSnap.exists()) {
                        userData = userDocSnap.data();
                        if (ADMIN_EMAILS.includes(user.email)) {
                            document.getElementById('admin-greeting').innerText = `Hello, ${userData.name}`;
                            showView('admin-view');
                            showAdminSection('admin-dashboard');
                        } else {
                            document.getElementById('user-greeting').innerText = `Hello, ${userData.name}`;
                            showView('app-view');
                            showStudentHomepage();
                        }
                    } else {
                        console.warn("User document not found, attempting to create it now.");
                        const name = user.displayName || "New User";
                        await setDoc(doc(db, "users", user.uid), { 
                            name: name, 
                            email: user.email, 
                            joined: new Date(),
                            completedUnits: [],
                            finalTestPassed: false
                        });
                        window.location.reload();
                    }
                } catch (error) {
                    console.error("Firestore Error after login:", error);
                    // NEW: If we can't read the user profile, log them out and show an error.
                    // This prevents the user from being "stuck".
                    await signOut(auth);
                    showError('login-error', `Login succeeded, but could not read your profile from the database. This is a Firestore Security Rules issue. Error: ${error.message}`);
                }
            } else {
                currentUser = null;
                userData = null;
                showView('auth-view');
            }
        });

        // --- VIEW MANAGEMENT & ERROR DISPLAY ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            // Hide loading view if it's not the target
            if (viewId !== 'loading-view') {
                document.getElementById('loading-view').classList.remove('active-view');
            }
            document.getElementById(viewId).classList.add('active-view');
        }
        
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        function clearErrors() {
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('signup-error').classList.add('hidden');
        }

        window.toggleAuthForms = () => {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('signup-form').classList.toggle('hidden');
            clearErrors();
        }

        // --- AUTHENTICATION FUNCTIONS ---
        window.loginUser = async () => {
            clearErrors();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) {
                showError('login-error', "Please fill all fields.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the view change
            } catch (error) {
                console.error("Login Error:", error);
                showError('login-error', `Login Failed: ${error.code}`);
            }
        };

        window.signupUser = async () => {
            clearErrors();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            if (!name || !email || !password) {
                showError('signup-error', "Please fill all fields.");
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle creating the database record
            } catch (error) {
                console.error("Signup Error:", error);
                showError('signup-error', `Signup Failed: ${error.code}`);
            }
        };

        window.logoutUser = async () => {
            await signOut(auth);
            window.location.reload();
        };
        
        // --- STUDENT VIEW FUNCTIONS ---
        async function showStudentHomepage() {
            const contentEl = document.getElementById('student-main-content');
            contentEl.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-3xl text-blue-500"></i></div>`;

            try {
                const pathsCollection = collection(db, "paths");
                const pathSnapshot = await getDocs(pathsCollection);
                const pathsList = pathSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                contentEl.innerHTML = `
                    <h2 class="text-3xl font-bold mb-2">Business: From Zero to Hero</h2>
                    <p class="text-lg text-gray-600 mb-8">Your journey to becoming a business expert starts here. Select a path to begin.</p>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="paths-container">
                        ${pathsList.length > 0 ? pathsList.map(path => `
                            <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition cursor-pointer" onclick="showPath('${path.id}')">
                                <h3 class="text-xl font-bold text-blue-700">${path.title}</h3>
                                <p class="text-gray-600 mt-2">${path.description}</p>
                            </div>
                        `).join('') : '<p class="text-gray-500 md:col-span-2 lg:col-span-3">No courses available yet. Please check back later.</p>'}
                    </div>
                    <div id="final-test-container" class="mt-8"></div>
                `;
            } catch (error) {
                console.error("Error fetching paths:", error);
                contentEl.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                    <p class="font-bold">Database Error</p>
                    <p>Could not load course content. The security rules for your Firestore database may be incorrect.</p>
                </div>`;
            }
        }

        // --- ADMIN VIEW FUNCTIONS ---
        window.showAdminSection = (sectionId) => {
            const contentEl = document.getElementById('admin-main-content');
            document.querySelectorAll('.admin-nav button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.admin-nav button[onclick="showAdminSection('${sectionId}')"]`).classList.add('active');

            switch(sectionId) {
                case 'admin-dashboard':
                    contentEl.innerHTML = `
                        <h2 class="text-2xl font-bold mb-4">Dashboard</h2>
                        <p>Welcome to the admin dashboard. Here you can manage the entire course content and user base.</p>
                        <div class="mt-6 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4">
                            <p class="font-bold">First-Time Setup</p>
                            <p>If you haven't added the 'Financial Skills' course yet, open the browser console (F12) and run: <code>seedFinancialSkillsPath()</code></p>
                        </div>
                    `;
                    break;
                case 'admin-paths':
                    renderPathManagement();
                    break;
                case 'admin-users':
                    renderUserManagement();
                    break;
            }
        }

        async function renderPathManagement() {
            const contentEl = document.getElementById('admin-main-content');
            contentEl.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Manage Paths</h2>
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4">Add New Path</h3>
                    <input id="new-path-title" class="w-full p-2 border rounded mb-2" placeholder="Path Title">
                    <textarea id="new-path-desc" class="w-full p-2 border rounded mb-2" placeholder="Path Description"></textarea>
                    <button onclick="addPath()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Add Path</button>
                </div>
                <div id="paths-list" class="space-y-4"><i class="fas fa-spinner fa-spin"></i> Loading paths...</div>
            `;
            
            const pathsCollection = collection(db, "paths");
            const pathSnapshot = await getDocs(pathsCollection);
            const pathsListEl = document.getElementById('paths-list');
            pathsListEl.innerHTML = '';
            pathSnapshot.forEach(doc => {
                pathsListEl.innerHTML += `
                    <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                        <div>
                            <p class="font-bold">${doc.data().title}</p>
                            <p class="text-sm text-gray-600">${doc.data().description}</p>
                        </div>
                        <button onclick="deletePath('${doc.id}')" class="text-red-500 hover:text-red-700 text-sm font-semibold">DELETE</button>
                    </div>
                `;
            });
        }
        window.addPath = async () => {
            const title = document.getElementById('new-path-title').value;
            const description = document.getElementById('new-path-desc').value;
            if (!title || !description) { alert('Please fill all fields'); return; }
            await addDoc(collection(db, "paths"), { title, description });
            renderPathManagement();
        }
        window.deletePath = async (pathId) => {
            if (!confirm('Are you sure you want to delete this path? This cannot be undone.')) return;
            await deleteDoc(doc(db, "paths", pathId));
            renderPathManagement();
        }

        async function renderUserManagement() {
            const contentEl = document.getElementById('admin-main-content');
            contentEl.innerHTML = `<h2 class="text-2xl font-bold mb-4">User List</h2><div id="users-list-container"><i class="fas fa-spinner fa-spin"></i> Loading users...</div>`;
            const usersContainer = document.getElementById('users-list-container');
            const usersSnapshot = await getDocs(collection(db, "users"));
            usersContainer.innerHTML = `
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${usersSnapshot.docs.map(doc => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">${doc.data().name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${doc.data().email}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${new Date(doc.data().joined.seconds * 1000).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // --- DATA SEEDING FUNCTION ---
        window.seedFinancialSkillsPath = async () => {
            console.log("Seeding Financial Skills Path...");
            const pathRef = doc(collection(db, "paths"));
            
            const modules = [
                { title: "Module 1 â€“ Understanding Money in Business", lessons: [{title: "What is Finance?", type:"text", content:"An overview of the role of finance in business success, from funding to financial management."}, {title: "Types of Business Finance", type:"text", content:"Exploring the differences between personal and business finances and why it matters."}, {title: "Basic Financial Terms", type:"text", content:"Defining key terms like Revenue, Expenses, Profit, Assets, and Liabilities."}] },
                { title: "Module 2 â€“ Budgeting & Financial Planning", lessons: [{title: "Why Budgeting Matters", type:"text", content:"How a budget helps maintain profitability and avoid common financial pitfalls."}, {title: "How to Create a Business Budget", type:"text", content:"A step-by-step guide with practical examples for service and product businesses."}, {title: "Forecasting Revenue & Expenses", type:"text", content:"Techniques for predicting future income and costs to plan effectively."}]},
                { title: "Module 3 â€“ Managing Cash Flow", lessons: [{title: "Cash Flow Basics", type:"text", content:"Understanding the critical difference between being profitable and being cash-flow positive."}, {title: "Common Cash Flow Problems", type:"text", content:"Identifying causes of poor cash flow and strategies to fix them."}, {title: "Tools & Templates for Tracking", type:"text", content:"Using simple tools like Excel or Google Sheets to monitor your cash flow."}]},
                { title: "Module 4 â€“ Business Accounting Basics", lessons: [{title: "Bookkeeping Essentials", type:"text", content:"The fundamentals of recording financial transactions accurately and efficiently."}, {title: "The Balance Sheet Explained", type:"text", content:"A deep dive into Assets, Liabilities, and Equity to understand your company's financial position."}, {title: "Reading an Income Statement", type:"text", content:"How to analyze your Profit & Loss (P&L) statement to gauge performance."}]},
                { title: "Module 5 â€“ Smart Financial Decision-Making", lessons: [{title: "Cost-Benefit Analysis", type:"text", content:"A framework for evaluating whether a new project or investment is financially viable."}, {title: "Break-Even Analysis", type:"text", content:"Calculating the point at which your business starts making a profit."}, {title: "Reducing Financial Risks", type:"text", content:"Strategies like diversification, maintaining emergency funds, and using insurance to protect your business."}]}
            ];

            const batch = writeBatch(db);
            
            batch.set(pathRef, {
                title: "Financial Skills â€“ From Basics to Business Mastery",
                description: "A comprehensive guide to understanding and managing money in your business."
            });

            for (const module of modules) {
                const unitRef = doc(collection(db, "paths", pathRef.id, "units"));
                batch.set(unitRef, { title: module.title, pathId: pathRef.id });
                for (const lesson of module.lessons) {
                    const lessonRef = doc(collection(db, "paths", pathRef.id, "units", unitRef.id, "lessons"));
                    batch.set(lessonRef, lesson);
                }
            }

            await batch.commit();
            alert("Financial Skills path and all its content have been seeded successfully! The page will now reload.");
            window.location.reload();
        }

    </script>
</body>
</html>
